name: Run Spectral linting

on:
    push:
      branches:
        - main
      paths:
        - "oas/*.yaml"
        - ".github/workflows/spectral.yaml"

permissions:
  checks: write
  # Give the default GITHUB_TOKEN write permission to commit and push the
  # added or changed files to the repository.
  contents: write

env:
  PYTHON_OAS_BUNDLING: "./oas/bundling.py"
  OAS_PATH: ./oas/root.oas.yaml
  SPECTRAL_IMAGE: "stoplight/spectral:6"

jobs:
  build:
    name: Run Spectral
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
        
    - uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
        virtualenvs-path: .venv
        installer-parallel: true

    - name: Install dependencies
      run: poetry install --no-interaction --no-root

    - name: OAS Bundling
      run: |
        poetry run python $PYTHON_OAS_BUNDLING

    - name: Spectral Linting
      id: spectral-lint
      run: |
          {
              echo 'linting-result<<EOF'
              echo -e "$(docker run --rm \
              --volume ${{ github.workspace }}:${{ github.workspace }} \
              --workdir ${{ github.workspace }} \
              --attach stdout \
              $SPECTRAL_IMAGE \
              lint $OAS_PATH --format github-actions)"
              echo ""
              echo "EOF"
          } >> $GITHUB_OUTPUT

    - name: Job summary          
      run: |
        ANNOTATIONS="${{ steps.spectral-lint.outputs.linting-result }}"
        # clean output removing trailing new line and removing message in case all went fine.
        ANNOTATIONS=$(echo "$ANNOTATIONS" | grep -vE "^No results with a severity of .* found\!$" | sed -r '/^\s*$/d')

        WARNNR=$(echo "$ANNOTATIONS" | grep warning | wc -l)
        ERRNR=$(echo "$ANNOTATIONS" | grep error | wc -l)
        # error + warning basically
        ATTENTIONLINES=$(($WARNNR + $ERRNR)) 

        if [ "$ATTENTIONLINES" -eq 0 ]; then
            ICON=":white_check_mark:"
        else
            ICON=":red_circle:"
        fi

        echo "ATTENTIONLINES=$ATTENTIONLINES" >> $GITHUB_ENV

        echo "### Spectral OAS analysis recap" >> $GITHUB_STEP_SUMMARY
        echo "| Test result | Warnings | Errors |" >> $GITHUB_STEP_SUMMARY
        echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
        echo "| ${ICON} | ${WARNNR} | ${ERRNR} |" >> $GITHUB_STEP_SUMMARY

    - name: Stylish job summary
      run: |
        {
            echo -e "$(docker run --rm \
            --volume ${{ github.workspace }}:/oas-docs \
            --workdir /oas-docs \
            --attach stdout \
            $SPECTRAL_IMAGE \
            lint $OAS_PATH --format stylish)" \
            | sed 's/ warning / :warning: /' \
            | sed 's/ error / :heavy_exclamation_mark: /'
        } >> $GITHUB_STEP_SUMMARY
        

    - name: Action return code
      run: |
        ERRNR="${{ env.ATTENTIONLINES }}"

        if [ "$ERRNR" -eq 0 ]; then
        # no point of attention, rc = 0
        exit 0
        else
        # there are warning(s)/error(s)
        # echo them, so they can be annotated, and rc != 0
        echo "$ERRNR"
        exit 1
        fi

    - uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 'Added or updated the bundle.yaml oas definition.'